# AI聊天群 - 会话隔离和角色管理指南

> **更新**: 2025-11-10  
> **功能**: 支持每个AI有独立的会话和角色身份

---

## 🎯 问题解决

### 原问题
所有AI都在同一个Cursor中使用同一个MCP配置，导致：
- ❌ 所有AI共享同一个消息存储
- ❌ 无法区分不同AI的身份
- ❌ 角色混淆

### 解决方案
✅ **会话隔离 + 角色管理**
- 每个AI注册时创建独立的会话ID
- 每个AI指定自己的角色（前端/后端/全栈/测试/产品经理）
- 消息中包含发送者的角色和会话信息
- 支持查看当前会话信息

---

## 🚀 使用流程

### 第一步：注册AI代理（必须）

**每个AI在使用前必须先注册，建立独立的身份**

#### 产品经理注册示例
```
register_agent({
  "agent_name": "manager",
  "role": "产品经理",
  "description": "产品经理AI助手，负责任务管理和团队协调"
})
```

#### 员工A（前端）注册示例
```
register_agent({
  "agent_name": "a",
  "role": "前端开发工程师",
  "description": "前端开发工程师，负责前端功能开发和UI/UX优化"
})
```

#### 员工B（后端）注册示例
```
register_agent({
  "agent_name": "b",
  "role": "后端开发工程师",
  "description": "后端开发工程师，负责后端API开发和数据库设计"
})
```

#### 员工C（全栈）注册示例
```
register_agent({
  "agent_name": "c",
  "role": "全栈开发工程师",
  "description": "全栈开发工程师，负责前后端集成和API文档"
})
```

#### 员工D（测试/运维）注册示例
```
register_agent({
  "agent_name": "d",
  "role": "测试/运维工程师",
  "description": "测试/运维工程师，负责测试体系建设和CI/CD流程"
})
```

### 第二步：查看当前会话信息

注册后，可以查看自己的会话信息：

```
get_current_session()
```

**返回信息**:
- 会话ID（唯一标识）
- 代理名称
- 角色
- 描述
- 创建时间
- 状态（活跃/非活跃）

### 第三步：发送和接收消息

注册后，就可以正常使用发送和接收消息功能了：

```
# 发送消息
send_message({
  "recipients": "a&b",
  "message": "API接口已完成，请前端对接"
})

# 接收消息
get_messages({
  "recipient": "*"
})
```

**消息中会包含**:
- 发送者名称
- **发送者角色**（新增）
- **发送者会话ID**（新增）
- 接收者列表
- 消息内容
- 时间戳

---

## 📋 关键特性

### 1. 会话隔离

- ✅ 每个AI有独立的会话ID
- ✅ 同一代理的多个会话中，只有一个是活跃的
- ✅ 消息中包含发送者的会话ID，可以追踪消息来源

### 2. 角色管理

- ✅ 每个AI注册时必须指定角色
- ✅ 消息中显示发送者的角色
- ✅ 可以通过角色区分不同AI的身份

### 3. 身份标识

- ✅ 代理名称（a/b/c/d/manager）
- ✅ 角色（前端开发工程师/后端开发工程师等）
- ✅ 会话ID（唯一标识）

---

## 💡 使用场景

### 场景1: 多AI协作

**产品经理** → **员工A** 和 **员工B**:
```
# 产品经理先注册
register_agent({
  "agent_name": "manager",
  "role": "产品经理",
  "description": "产品经理AI助手"
})

# 然后发送任务
send_message({
  "recipients": "a&b",
  "message": "请完成知识库本地文件夹挂载功能"
})
```

**员工A** 和 **员工B** 接收消息时，会看到：
- 发送者: manager (产品经理)
- 消息内容: ...

### 场景2: 角色区分

即使多个AI使用相同的代理名称（如都叫"a"），通过会话ID和角色也可以区分：

- 会话ID不同 → 不同的AI实例
- 角色不同 → 不同的职责

---

## 🔧 技术实现

### 数据存储

- `messages.json`: 消息历史（共享）
- `agents.json`: AI代理信息
- `sessions.json`: **会话信息（新增）**

### 会话管理

- 每个会话有唯一的UUID
- 同一代理的旧会话会被标记为非活跃
- 只有活跃会话可以发送消息

### 消息格式

```json
{
  "id": "消息ID",
  "sender": "发送者名称",
  "sender_role": "发送者角色",  // 新增
  "sender_session_id": "会话ID",  // 新增
  "recipients": ["接收者1", "接收者2"],
  "content": "消息内容",
  "timestamp": "2025-11-10T12:00:00",
  "read": {
    "接收者1": false,
    "接收者2": false
  }
}
```

---

## ⚠️ 重要提醒

1. **必须先注册**: 每个AI在使用前必须先调用 `register_agent`
2. **会话ID唯一**: 每个AI的会话ID是唯一的，用于区分不同的AI实例
3. **角色必填**: 注册时必须提供角色信息
4. **共享消息池**: 所有AI共享同一个消息池，但通过会话ID和角色区分

---

## 📚 相关文档

- **使用文档**: `mcp_ai_chat/README.md`
- **使用示例**: `mcp_ai_chat/USAGE_EXAMPLES.md`
- **安装指南**: `mcp_ai_chat/install.md`

---

**文档版本**: v2.0.0  
**最后更新**: 2025-11-10  
**功能**: 会话隔离和角色管理


