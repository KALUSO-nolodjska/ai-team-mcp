# AI聊天群 MCP工具 - 更新说明

> **更新版本**: v2.0.0  
> **更新日期**: 2025-11-10  
> **更新内容**: 会话隔离和角色管理

---

## 🎯 更新目的

解决所有AI在同一个Cursor中使用同一个MCP配置导致的问题：
- ❌ 无法区分不同AI的身份
- ❌ 角色混淆
- ❌ 消息来源不明确

---

## ✨ 新增功能

### 1. 会话隔离

- ✅ 每个AI注册时自动创建独立的会话ID
- ✅ 会话ID是UUID格式，确保唯一性
- ✅ 同一代理的多个会话中，只有一个是活跃的
- ✅ 消息中包含发送者的会话ID

### 2. 角色管理

- ✅ `register_agent` 工具现在需要提供 `role` 参数（必填）
- ✅ 消息中显示发送者的角色
- ✅ `list_agents` 显示每个代理的角色和活跃状态

### 3. 新增工具

- ✅ `get_current_session`: 获取当前AI的会话信息

---

## 🔄 变更内容

### 1. `register_agent` 工具变更

**之前**:
```json
{
  "agent_name": "manager",
  "description": "产品经理AI助手"
}
```

**现在**:
```json
{
  "agent_name": "manager",
  "role": "产品经理",  // 新增，必填
  "description": "产品经理AI助手"
}
```

### 2. 消息格式变更

**新增字段**:
- `sender_role`: 发送者角色
- `sender_session_id`: 发送者会话ID

### 3. 数据存储变更

**新增文件**:
- `sessions.json`: 存储会话信息

---

## 📋 使用指南

### 第一步：注册AI代理（必须）

每个AI在使用前必须先注册：

```
register_agent({
  "agent_name": "manager",
  "role": "产品经理",
  "description": "产品经理AI助手"
})
```

### 第二步：查看会话信息

```
get_current_session()
```

### 第三步：正常使用

注册后，就可以正常使用发送和接收消息功能了。

---

## ⚠️ 迁移指南

### 对于已注册的AI

如果之前已经注册过AI代理，需要重新注册以创建会话：

1. 调用 `register_agent` 重新注册（现在需要提供 `role` 参数）
2. 系统会自动创建新的会话ID
3. 旧的消息仍然保留，但新消息会包含会话信息

### 对于新AI

直接按照新的流程注册即可。

---

## 🔧 技术细节

### 会话管理

- 会话ID使用UUID格式：`xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- 同一代理的旧会话会被标记为 `active: false`
- 只有活跃会话可以发送消息

### 数据文件

- `~/.mcp_ai_chat/messages.json`: 消息历史
- `~/.mcp_ai_chat/agents.json`: AI代理信息
- `~/.mcp_ai_chat/sessions.json`: **会话信息（新增）**

---

## ✅ 兼容性

- ✅ 向后兼容：旧的消息格式仍然支持
- ✅ 新消息自动包含会话信息
- ✅ 旧AI可以重新注册以创建会话

---

## 📚 相关文档

- **会话和角色指南**: `mcp_ai_chat/SESSION_ROLE_GUIDE.md`
- **使用文档**: `mcp_ai_chat/README.md`
- **使用示例**: `mcp_ai_chat/USAGE_EXAMPLES.md`

---

**更新版本**: v2.0.0  
**更新日期**: 2025-11-10  
**维护者**: 产品经理


