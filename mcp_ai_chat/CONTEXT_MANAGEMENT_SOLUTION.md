# 上下文长度管理解决方案

> **问题**: AI上下文长度有限，群聊消息过多会导致上下文过长  
> **创建时间**: 2025-11-10

---

## 🎯 问题分析

### 挑战
1. **上下文限制**: AI有token限制，不能接收所有历史消息
2. **消息积累**: 群组消息会不断积累，导致上下文过长
3. **信息过载**: 大量历史消息会干扰当前讨论

---

## 💡 解决方案

### 方案1: 消息分页和限制（推荐）✅

**核心思路**: 只获取最近的、相关的消息

#### 实现方式

1. **默认限制消息数量**
   ```
   receive_group_messages({
     "group_id": "GROUP_001",
     "limit": 20,  // 只获取最近20条
     "unread_only": true  // 优先未读消息
   })
   ```

2. **时间范围过滤**
   ```
   receive_group_messages({
     "group_id": "GROUP_001",
     "since": "2025-11-10T00:00:00",  // 只获取此时间之后的消息
     "limit": 50
   })
   ```

3. **关键词过滤**
   ```
   receive_group_messages({
     "group_id": "GROUP_001",
     "keywords": ["API", "接口"],  // 只获取包含关键词的消息
     "limit": 20
   })
   ```

#### 优势
- ✅ 简单实用，立即生效
- ✅ 不改变消息存储结构
- ✅ 灵活控制上下文大小

---

### 方案2: 消息摘要和总结

**核心思路**: 定期总结群组消息，生成摘要

#### 实现方式

1. **自动生成摘要**
   ```
   summarize_group_messages({
     "group_id": "GROUP_001",
     "time_range": "last_7_days",  // 总结最近7天的消息
     "max_length": 500  // 摘要最大长度
   })
   ```

2. **关键信息提取**
   - 提取决策、任务分配、问题解决等关键信息
   - 忽略日常讨论和确认消息

#### 优势
- ✅ 大幅减少上下文长度
- ✅ 保留关键信息
- ✅ 便于快速了解项目进展

---

### 方案3: 话题/主题分离

**核心思路**: 按话题组织消息，而不是时间线

#### 实现方式

1. **消息打标签**
   ```
   send_group_message({
     "group_id": "GROUP_001",
     "topic": "API接口设计",  // 消息主题
     "message": "API接口已完成"
   })
   ```

2. **按话题接收**
   ```
   receive_group_messages({
     "group_id": "GROUP_001",
     "topic": "API接口设计",  // 只获取此话题的消息
     "limit": 20
   })
   ```

#### 优势
- ✅ 消息组织更清晰
- ✅ 只关注相关话题
- ✅ 减少无关信息干扰

---

### 方案4: 消息归档和清理

**核心思路**: 定期归档旧消息，只保留活跃讨论

#### 实现方式

1. **自动归档**
   ```
   archive_group_messages({
     "group_id": "GROUP_001",
     "before": "2025-11-01",  // 归档此日期之前的消息
     "keep_summary": true  // 保留摘要
   })
   ```

2. **手动清理**
   ```
   clear_group_messages({
     "group_id": "GROUP_001",
     "keep_recent": 100  // 只保留最近100条
   })
   ```

#### 优势
- ✅ 保持消息池清洁
- ✅ 提高查询效率
- ✅ 减少存储压力

---

## 🎯 推荐方案组合

### 最佳实践组合

1. **消息分页**（必须）
   - 默认限制消息数量（20-50条）
   - 支持时间范围过滤
   - 支持关键词过滤

2. **消息摘要**（推荐）
   - 定期生成群组摘要
   - 提取关键决策和进展
   - 用于快速了解项目状态

3. **话题分离**（可选）
   - 按话题组织消息
   - 适合大型项目讨论

### 实施优先级

- **P0**: 消息分页和限制（立即实施）
- **P1**: 消息摘要功能（后续优化）
- **P2**: 话题分离（可选功能）

---

## 🔧 技术实现

### 消息接收优化

```python
def receive_group_messages(
    group_id: str,
    limit: int = 20,  # 默认限制
    since: Optional[str] = None,  # 时间过滤
    keywords: Optional[list] = None,  # 关键词过滤
    unread_only: bool = False,  # 只未读
    topic: Optional[str] = None  # 话题过滤
):
    """
    接收群组消息，支持多种过滤方式
    """
    # 1. 加载消息
    # 2. 按群组过滤
    # 3. 应用时间过滤
    # 4. 应用关键词过滤
    # 5. 应用话题过滤
    # 6. 限制数量
    # 7. 返回结果
```

### 消息摘要生成

```python
def summarize_group_messages(
    group_id: str,
    time_range: str = "last_7_days",
    max_length: int = 500
):
    """
    生成群组消息摘要
    """
    # 1. 获取指定时间范围的消息
    # 2. 提取关键信息（决策、任务、问题）
    # 3. 生成摘要
    # 4. 返回摘要
```

---

## 💡 使用建议

### 日常使用

1. **开始工作时**
   ```
   # 先获取摘要，了解项目状态
   summarize_group_messages({
     "group_id": "GROUP_001",
     "time_range": "last_24_hours"
   })
   
   # 再获取未读消息
   receive_group_messages({
     "group_id": "GROUP_001",
     "unread_only": true,
     "limit": 20
   })
   ```

2. **参与讨论时**
   ```
   # 只获取最近的相关消息
   receive_group_messages({
     "group_id": "GROUP_001",
     "limit": 10,  # 只获取最近10条
     "keywords": ["当前讨论的话题"]
   })
   ```

3. **查找历史信息**
   ```
   # 使用摘要而不是完整消息
   summarize_group_messages({
     "group_id": "GROUP_001",
     "time_range": "last_30_days"
   })
   ```

---

## ✅ 总结

### 核心策略

1. **消息分页**：默认限制数量，避免一次性加载过多
2. **智能过滤**：按时间、关键词、话题过滤
3. **消息摘要**：定期总结，保留关键信息
4. **按需加载**：只获取需要的信息

### 实施建议

- **立即实施**: 消息分页和限制
- **后续优化**: 消息摘要功能
- **可选功能**: 话题分离

这样既能享受群聊的便利，又能避免上下文过长的问题。

---

**文档版本**: v1.0.0  
**创建时间**: 2025-11-10

